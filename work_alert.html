<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê³¼ì œ ê³µì§€</title>
<link rel="stylesheet" href="./common.css">
<style>
  body {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  #teacherBox {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
  }

  #teacherBox h3 {
    margin-top: 0;
    color: #333;
  }

  #teacherBox input:not([type="checkbox"]),
  #teacherBox select {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 2px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
  }

  .class-checkboxes {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin: 10px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
  }

 .class-checkbox-item {
   display: flex;
   align-items: center;
   gap: 8px;
}

.class-checkbox-item label {
  display: flex;
  align-items: center;
  gap: 6px;
}

  .class-checkbox-item input[type="checkbox"] {
    width: auto;
    margin: 0;
    cursor: pointer;
  }

  .class-checkbox-item label {
    cursor: pointer;
    font-size: 14px;
    color: #333;
  }

  .class-select-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
    display: block;
    font-weight: 500;
  }

  #teacherBox button {
    width: 100%;
    padding: 12px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
  }

  #teacherBox button:hover {
    background: #45a049;
  }

  .notice {
    background: white;
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 10px;
    border-left: 4px solid #667eea;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .notice h3 {
    margin-top: 0;
    color: #333;
  }

  .notice p {
    margin: 8px 0;
    color: #666;
  }

  .notice button {
    padding: 10px 20px;
    margin-top: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }

  .notice button:not(:disabled) {
    background: #667eea;
    color: white;
  }

  .notice button:not(:disabled):hover {
    background: #5568d3;
  }

  .notice button:disabled {
    background: #ccc;
    color: #666;
    cursor: not-allowed;
  }

  .delete-btn {
    background: #ff6b6b !important;
    color: white !important;
    margin-left: 10px;
  }

  .delete-btn:hover {
    background: #fa5252 !important;
  }

  details {
    margin-top: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
  }

  summary {
    cursor: pointer;
    font-weight: bold;
    color: #667eea;
  }

  .submitter-list {
    margin-top: 10px;
    padding-left: 20px;
  }

  .deadline-passed {
    border-left-color: #ff6b6b;
  }

  .deadline-soon {
    border-left-color: #ffa500;
  }

  .status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 10px;
  }

  .badge-completed {
    background: #d4edda;
    color: #155724;
  }

  .badge-pending {
    background: #fff3cd;
    color: #856404;
  }

  .badge-closed {
    background: #f8d7da;
    color: #721c24;
  }
</style>
</head>
<body>
<div class="header">
  <h2>ğŸ“¢ ê³¼ì œ ê³µì§€</h2>
  <a href="index.html">â† í™ˆ</a>
</div>

<!-- ì„ ìƒë‹˜ ì „ìš© -->
<div id="teacherBox"></div>
<div id="workArea"></div>

<script>
// =========================
// ê³µí†µ ìœ í‹¸ í•¨ìˆ˜
// =========================
function normalizeDate(d) {
  const date = new Date(d);
  date.setHours(0, 0, 0, 0);
  return date;
}

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[m]));
}

// =========================
// ë¡œê·¸ì¸ ì •ë³´
// =========================
const loginData = JSON.parse(localStorage.getItem("loginUser") || "{}");
const ROLE = loginData.role;

const USER = ROLE === "student"
  ? `${loginData.grade}í•™ë…„ ${loginData.classNum}ë°˜ ${loginData.number}ë²ˆ`
  : loginData.name;

const CLASS = Number(loginData.classNum);

// =========================
// ê³¼ì œ ë°ì´í„°
// =========================
let works = JSON.parse(localStorage.getItem("works")) || [];

// =========================
// ê³¼ì œ ì¶”ê°€ (êµì‚¬)
// =========================
function addWork() {
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();
  const deadline = document.getElementById("deadline").value;

  const checkboxes = document.querySelectorAll(".class-checkbox:checked");
  const selectedClasses = Array.from(checkboxes).map(cb => Number(cb.value));

  if (!title || !content || !deadline) {
    alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  if (selectedClasses.length === 0) {
    alert("ìµœì†Œ 1ê°œ ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  selectedClasses.forEach(targetClass => {
    works.push({
      id: "work_" + Date.now() + "_" + Math.floor(Math.random() * 10000),
      title,
      content,
      deadline,
      grade: Number(loginData.grade), // â† ì¶”ê°€
      class: targetClass,
      createdBy: USER
    });
  });

  localStorage.setItem("works", JSON.stringify(works));

  document.getElementById("title").value = "";
  document.getElementById("content").value = "";
  document.getElementById("deadline").value = "";
  checkboxes.forEach(cb => cb.checked = false);

  render();
}

// =========================
// ê³¼ì œ ì‚­ì œ (êµì‚¬)
// =========================
function deleteWork(id) {
  if (!confirm("ì •ë§ ì´ ê³¼ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  works = works.filter(w => w.id !== id);
  localStorage.setItem("works", JSON.stringify(works));
  localStorage.removeItem("submit_" + id);

  render();
}

// =========================
// ê³¼ì œ ì œì¶œ (í•™ìƒ)
// =========================
function submit(id) {
  const work = works.find(w => w.id === id);
  if (!work) return;

  const today = normalizeDate(new Date());
  const deadline = normalizeDate(work.deadline);

  if (today > deadline) {
    alert("ë§ˆê°ëœ ê³¼ì œì…ë‹ˆë‹¤.");
    return;
  }

  const key = "submit_" + id;
  let list = JSON.parse(localStorage.getItem(key)) || [];

  if (!list.includes(USER)) {
    list.push(USER);
    localStorage.setItem(key, JSON.stringify(list));
    alert("ê³¼ì œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.");
    render();
  }
}

// =========================
// ë§ˆê° ìƒíƒœ íŒë‹¨
// =========================
function getDeadlineStatus(deadline) {
  const today = normalizeDate(new Date());
  const deadlineDate = normalizeDate(deadline);

  const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

  if (diffDays < 0) return "passed";
  if (diffDays <= 2) return "soon";
  return "normal";
}

// =========================
// í™”ë©´ ë Œë”ë§
// =========================
function render() {
  const workArea = document.getElementById("workArea");
  const teacherBox = document.getElementById("teacherBox");

  workArea.innerHTML = "";
  teacherBox.innerHTML = "";

  // êµì‚¬ìš© UI
  if (ROLE === "teacher") {
    teacherBox.innerHTML = `
      <h3>ğŸ“ ê³¼ì œ ì¶”ê°€</h3>
      <input id="title" placeholder="ê³¼ì œ ì œëª©">
      <input id="content" placeholder="ê³¼ì œ ë‚´ìš©">
      <input id="deadline" type="date">
      <label class="class-select-label">ëŒ€ìƒ ë°˜ ì„ íƒ</label>
      <div class="class-checkboxes">
        ${[1,2,3,4,5,6,7].map(n => `
          <div class="class-checkbox-item">
            <label>
               <input type="checkbox" class="class-checkbox" value="${n}">
               ${n}ë°˜
            </label>
          </div>
        `).join("")}
      </div>
      <button onclick="addWork()">ê³¼ì œ ì¶”ê°€</button>
    `;
  }

  const myWorks = ROLE === "teacher"
    ? works
    : works.filter(w =>
        w.grade === Number(loginData.grade) &&
        w.class === CLASS
      );


  if (myWorks.length === 0) {
    workArea.innerHTML = `
      <div class="notice">
        <p style="text-align:center;color:#999;">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    `;
    return;
  }

  myWorks.forEach(w => {
    const key = "submit_" + w.id;
    const list = JSON.parse(localStorage.getItem(key)) || [];

    const submitted = list.includes(USER);
    const closed = normalizeDate(new Date()) > normalizeDate(w.deadline);

    const status = getDeadlineStatus(w.deadline);
    const statusClass =
      status === "passed" ? "deadline-passed" :
      status === "soon" ? "deadline-soon" : "";

    let badge = "";
    if (ROLE === "student") {
      if (submitted) badge = '<span class="status-badge badge-completed">ì œì¶œ ì™„ë£Œ</span>';
      else if (closed) badge = '<span class="status-badge badge-closed">ë§ˆê°</span>';
      else badge = '<span class="status-badge badge-pending">ë¯¸ì œì¶œ</span>';
    }

    workArea.innerHTML += `
      <div class="notice ${statusClass}">
        <h3>${escapeHTML(w.title)} ${badge}</h3>
        ${ROLE === "teacher" ? `<p>ëŒ€ìƒ: ${w.class}ë°˜</p>` : ""}
        <p>${escapeHTML(w.content)}</p>
        <p>ë§ˆê°ì¼: ${w.deadline}${closed ? " (ë§ˆê°ë¨)" : ""}</p>

        ${ROLE === "student" ? `
          <button onclick="submit('${w.id}')"
            ${submitted || closed ? "disabled" : ""}>
            ${submitted ? "ì œì¶œ ì™„ë£Œ" : closed ? "ë§ˆê°ë¨" : "ì œì¶œí•˜ê¸°"}
          </button>
        ` : `
          <p>ì œì¶œ: ${list.length}ëª…</p>
          <details>
            <summary>ì œì¶œì ëª…ë‹¨</summary>
            ${list.length ? list.map(n => `<p>âœ“ ${n}</p>`).join("") : "<p>ì—†ìŒ</p>"}
          </details>
          <button class="delete-btn" onclick="deleteWork('${w.id}')">ì‚­ì œ</button>
        `}
      </div>
    `;
  });
}

render();

</script>
